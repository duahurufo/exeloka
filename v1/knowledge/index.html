<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Sources - Exeloka</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="../dashboard.html" class="logo">Exeloka</a>
                <nav>
                    <ul class="nav">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="../projects/">Projects</a></li>
                        <li><a href="index.html" class="active">Knowledge</a></li>
                        <li><a href="../recommendations/">Recommendations</a></li>
                    </ul>
                </nav>
                <div class="user-menu">
                    <button class="user-btn" onclick="toggleUserMenu()">
                        <span id="userName">User</span> ‚ñº
                    </button>
                    <div id="userDropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--border); border-radius: 0.375rem; box-shadow: var(--shadow); min-width: 150px; z-index: 1000;">
                        <a href="../profile.html" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: var(--secondary); border-bottom: 1px solid var(--border);">Profile</a>
                        <a href="#" onclick="logout()" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: var(--secondary);">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                    <div>
                        <h1 class="page-title">Knowledge Sources</h1>
                        <p class="page-subtitle">Manage cultural wisdom and documentation for better project recommendations</p>
                    </div>
                    <a href="add.html" class="btn btn-primary">
                        üìö Add Knowledge Source
                    </a>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="row">
                    <div class="col-8">
                        <div class="form-group">
                            <input type="text" id="searchQuery" class="form-control" placeholder="Search knowledge sources by title, content, or tags..." onkeyup="performSearch()">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <select id="categoryFilter" class="form-control form-select" onchange="filterByCategory()">
                                <option value="">All Categories</option>
                                <option value="Cultural">Cultural Practices</option>
                                <option value="Religious">Religious Guidelines</option>
                                <option value="Business">Business Practices</option>
                                <option value="Legal">Legal Requirements</option>
                                <option value="Historical">Historical Context</option>
                                <option value="Language">Language & Communication</option>
                                <option value="Community">Community Relations</option>
                                <option value="Economic">Economic Patterns</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button onclick="filterByType('document')" class="btn btn-secondary btn-sm">üìÑ Documents</button>
                    <button onclick="filterByType('url')" class="btn btn-secondary btn-sm">üîó Web Sources</button>
                    <button onclick="filterByType('manual')" class="btn btn-secondary btn-sm">‚úèÔ∏è Manual Entry</button>
                    <button onclick="clearFilters()" class="btn btn-warning btn-sm">Clear Filters</button>
                </div>
            </div>

            <!-- Knowledge Sources Grid -->
            <div id="knowledgeContainer">
                <!-- Loading placeholder -->
                <div class="card text-center" id="loadingCard">
                    <div style="padding: 3rem;">
                        <p>‚è≥ Loading knowledge sources...</p>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" style="display: none; text-align: center; margin-top: 2rem;">
                <div style="display: inline-flex; gap: 0.5rem; align-items: center;">
                    <button onclick="changePage(-1)" class="btn btn-secondary" id="prevBtn">‚Üê Previous</button>
                    <span id="pageInfo" style="margin: 0 1rem; font-weight: 500;">Page 1 of 1</span>
                    <button onclick="changePage(1)" class="btn btn-secondary" id="nextBtn">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </main>

    <footer style="background: var(--dark); color: white; padding: 2rem 0; text-align: center; margin-top: 4rem;">
        <div class="container">
            <p>&copy; 2024 Exeloka. Cultural Wisdom Recommendation System for Sampang, East Java.</p>
            <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
                Empowering companies to build meaningful relationships with local communities.
            </p>
        </div>
    </footer>

    <script src="../assets/js/mock-api.js"></script>
    <script src="../assets/js/api.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const user = JSON.parse(sessionStorage.getItem('user') || 'null');
            if (!user) {
                window.location.href = '../login.html';
                return;
            }
            
            document.getElementById('userName').textContent = user.full_name || user.email;
            
            // Load knowledge sources
            loadKnowledgeSources();
        });

        async function loadKnowledgeSources(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 12,
                    ...currentFilters
                });
                
                const response = await api.searchKnowledge(params);
                displayKnowledgeSources(response.data);
                updatePagination(response.pagination);
                
            } catch (error) {
                document.getElementById('knowledgeContainer').innerHTML = `
                    <div class="card">
                        <div class="text-center" style="padding: 3rem;">
                            <p style="color: var(--danger); margin-bottom: 1rem;">‚ùå Failed to load knowledge sources</p>
                            <p style="color: var(--secondary);">${error.message}</p>
                            <button onclick="loadKnowledgeSources()" class="btn btn-primary mt-2">üîÑ Retry</button>
                        </div>
                    </div>
                `;
            }
        }

        function displayKnowledgeSources(knowledgeSources) {
            const container = document.getElementById('knowledgeContainer');
            
            if (!knowledgeSources || knowledgeSources.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="text-center" style="padding: 3rem;">
                            <p style="margin-bottom: 1rem;">üìö No knowledge sources found</p>
                            <p style="color: var(--secondary); margin-bottom: 2rem;">Start building your cultural knowledge base</p>
                            <a href="add.html" class="btn btn-primary">Add Your First Knowledge Source</a>
                        </div>
                    </div>
                `;
                return;
            }

            const html = knowledgeSources.map(source => `
                <div class="card knowledge-card" data-category="${source.category}" data-type="${source.source_type}">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">
                                ${getSourceTypeIcon(source.source_type)} ${source.title}
                            </h3>
                            <div style="display: flex; gap: 1rem; color: var(--secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <span>üìÅ ${source.category || 'General'}</span>
                                <span>üë§ ${source.created_by_name || 'System'}</span>
                                <span>üìÖ ${formatDate(source.created_at)}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${source.confidence_score ? `<span class="badge badge-${getConfidenceBadgeClass(source.confidence_score)}">${source.confidence_score}% confidence</span>` : ''}
                            <span class="badge badge-secondary">${source.usage_count || 0} uses</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <p style="color: var(--secondary); line-height: 1.5;">
                            ${source.summary || source.content ? (source.summary || source.content).substring(0, 200) + '...' : 'No description available'}
                        </p>
                        ${source.tags ? `
                            <div style="margin-top: 0.5rem;">
                                ${source.tags.split(',').map(tag => `<span class="badge badge-info">${tag.trim()}</span>`).join(' ')}
                            </div>
                        ` : ''}
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="viewSource(${source.id})" class="btn btn-primary btn-sm">üëÅÔ∏è View</button>
                            <button onclick="editSource(${source.id})" class="btn btn-secondary btn-sm">‚úèÔ∏è Edit</button>
                            <button onclick="useInProject(${source.id})" class="btn btn-success btn-sm">üéØ Use in Project</button>
                        </div>
                        <button onclick="deleteSource(${source.id})" class="btn btn-danger btn-sm" title="Delete source">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem;">${html}</div>`;
        }

        function getSourceTypeIcon(type) {
            const icons = {
                'document': 'üìÑ',
                'url': 'üîó',
                'manual': '‚úèÔ∏è',
                'image': 'üñºÔ∏è'
            };
            return icons[type] || 'üìö';
        }

        function getConfidenceBadgeClass(score) {
            if (score >= 80) return 'success';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function updatePagination(pagination) {
            if (!pagination) return;
            
            currentPage = pagination.current_page;
            totalPages = pagination.total_pages;
            
            const paginationContainer = document.getElementById('paginationContainer');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (totalPages > 1) {
                paginationContainer.style.display = 'block';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                loadKnowledgeSources(newPage);
            }
        }

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (query) {
                currentFilters.search = query;
            } else {
                delete currentFilters.search;
            }
            loadKnowledgeSources(1);
        }

        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            if (category) {
                currentFilters.category = category;
            } else {
                delete currentFilters.category;
            }
            loadKnowledgeSources(1);
        }

        function filterByType(type) {
            currentFilters.source_type = type;
            loadKnowledgeSources(1);
        }

        function clearFilters() {
            currentFilters = {};
            document.getElementById('searchQuery').value = '';
            document.getElementById('categoryFilter').value = '';
            loadKnowledgeSources(1);
        }

        function viewSource(id) {
            window.location.href = `view.html?id=${id}`;
        }

        function editSource(id) {
            window.location.href = `edit.html?id=${id}`;
        }

        function useInProject(id) {
            // Store selected knowledge source and redirect to new project
            sessionStorage.setItem('selectedKnowledgeSource', id);
            window.location.href = '../projects/new.html';
        }

        async function deleteSource(id) {
            if (!confirm('Are you sure you want to delete this knowledge source? This action cannot be undone.')) {
                return;
            }

            try {
                await api.deleteKnowledge(id);
                showAlert('Knowledge source deleted successfully', 'success');
                loadKnowledgeSources(currentPage);
            } catch (error) {
                showAlert('Failed to delete knowledge source: ' + error.message, 'danger');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function logout() {
            sessionStorage.removeItem('user');
            window.location.href = '../login.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            if (!userMenu.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>

    <style>
        .knowledge-card {
            transition: all 0.2s;
        }

        .knowledge-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            border-radius: 0.25rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .badge-danger {
            background-color: var(--danger);
            color: white;
        }

        .badge-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .badge-info {
            background-color: var(--info);
            color: white;
        }
    </style>

    <div data-component="footer"></div>
    
    <script src="../includes/components.js"></script>
</body>
</html>